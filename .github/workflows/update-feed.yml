name: Update Kite Feed and Deploy

on:
  schedule:
    # Run every 6 hours including 13:00 UTC (at 01:00, 07:00, 13:00, 19:00)
    - cron: '0 1,7,13,19 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        uv sync
        
    - name: Fetch existing stories from GitHub Pages
      run: |
        echo "=== Fetching existing story files from GitHub Pages ==="
        # Create stories directory if it doesn't exist
        mkdir -p stories
        # Try to fetch existing stories from the deployed site
        # This preserves old story HTML files even after they're removed from the feed
        REPO_NAME="${{ github.event.repository.name }}"
        OWNER="${{ github.repository_owner }}"
        BASE_URL="https://${OWNER}.github.io/${REPO_NAME}"
        
        echo "Checking for existing deployment at: ${BASE_URL}"
        
        # Try to fetch the index page to get links to story files
        if curl -f -s "${BASE_URL}/index.html" -o /tmp/index.html 2>/dev/null; then
          echo "Found existing deployment. Fetching story file list..."
          # Extract story links from index.html
          grep -oP 'href="stories/[^"]+\.html"' /tmp/index.html 2>/dev/null | sed 's/href="//;s/"//' | while read story_path; do
            story_file=$(basename "$story_path")
            echo "Downloading existing story: $story_file"
            curl -f -s "${BASE_URL}/${story_path}" -o "stories/$story_file" 2>/dev/null || echo "  Failed to download $story_file"
          done
          rm -f /tmp/index.html
          echo "Existing story files preserved: $(ls -1 stories/*.html 2>/dev/null | wc -l)"
        else
          echo "No existing GitHub Pages deployment found. Starting fresh."
        fi
        
    - name: Run processing workflow
      run: |
        uv run process
        
    - name: Verify generated files
      run: |
        echo "=== Verifying Generated Files ==="
        echo ""
        echo "Checking key files:"
        for file in processed_stories.json feed.xml index.html; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file" 2>/dev/null || echo "unknown")
            mtime=$(stat -c%y "$file" 2>/dev/null || stat -f%Sm "$file" 2>/dev/null || echo "unknown")
            echo "  ✓ $file exists ($size bytes, modified: $mtime)"
          else
            echo "  ✗ $file MISSING!"
            exit 1
          fi
        done
        echo ""
        echo "Checking stories directory:"
        if [ -d "stories" ]; then
          story_count=$(find stories -name "*.html" -type f | wc -l)
          total_size=$(du -sb stories 2>/dev/null | cut -f1 || echo "unknown")
          echo "  ✓ stories/ directory exists"
          echo "  ✓ Found $story_count HTML files (total size: $total_size bytes)"
          if [ "$story_count" -eq 0 ]; then
            echo "  ⚠️  WARNING: No story HTML files found!"
          fi
        else
          echo "  ✗ stories/ directory MISSING!"
          exit 1
        fi
        echo ""
        echo "File sizes summary:"
        du -h processed_stories.json feed.xml index.html 2>/dev/null || true
        echo ""
        echo "Directory listing (first 15 items):"
        ls -lh | head -15
        echo ""
        echo "Stories directory contents (first 10):"
        ls -lh stories/ 2>/dev/null | head -10 || echo "  (empty or error)"
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Log deployment status
      run: |
        echo "=== Deployment Status ==="
        echo "Page URL: ${{ steps.deployment.outputs.page_url }}"
        echo "Deployment completed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
