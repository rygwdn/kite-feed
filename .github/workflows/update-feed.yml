name: Update Kite Feed and Deploy

on:
  schedule:
    # Run every 6 hours including 13:00 UTC (at 01:00, 07:00, 13:00, 19:00)
    - cron: '0 1,7,13,19 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches:
      - main

permissions:
  contents: write  # Need write permission to push to gh-pages

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        path: main
      
    - name: Ensure gh-pages branch exists
      run: |
        cd main
        
        # Check if gh-pages branch exists on remote
        if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
          echo "gh-pages branch exists"
        else
          echo "Creating gh-pages branch"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create orphan branch
          git checkout --orphan gh-pages
          git rm -rf .
          
          # Create initial commit with .nojekyll
          touch .nojekyll
          mkdir -p stories
          git add .nojekyll stories/.gitkeep
          echo "" > stories/.gitkeep
          git add stories/.gitkeep
          git commit -m "Initialize gh-pages branch"
          git push origin gh-pages
          
          # Switch back to main
          git checkout main
        fi
        
        cd ..
      
    - name: Checkout gh-pages branch
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages
      
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      working-directory: main
      run: |
        uv sync
        
    - name: Run processing workflow in gh-pages directory
      run: |
        echo "=== Running build in gh-pages directory ==="
        cd gh-pages
        
        # Count existing stories
        existing_count=$(ls -1 stories/*.html 2>/dev/null | wc -l || echo "0")
        echo "Existing stories: $existing_count"
        
        # Create stories directory if it doesn't exist
        mkdir -p stories
        
        # Copy necessary files from main (config and templates)
        cp ../main/config.json .
        cp -r ../main/templates .
        
        # Run the processing workflow using main's scripts and dependencies
        cd ../main
        uv run python <<EOF
import os
import sys

# Change to gh-pages directory where we want output
os.chdir('../gh-pages')

# Add main directory to path so we can import modules
sys.path.insert(0, '../main')

# Import and run the main function
from process_workflow import main
main()
EOF
        
        cd ../gh-pages
        
        # Clean up temporary files (keep generated content)
        rm -f config.json
        rm -rf templates
        
        echo "Generated files in gh-pages directory"
        new_count=$(ls -1 stories/*.html 2>/dev/null | wc -l || echo "0")
        echo "Total stories now: $new_count (added $((new_count - existing_count)) new)"
        
    - name: Verify generated files
      working-directory: gh-pages
      run: |
        echo "=== Verifying Generated Files ==="
        echo ""
        echo "Checking key files:"
        for file in feed.xml index.html; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file" 2>/dev/null || echo "unknown")
            mtime=$(stat -c%y "$file" 2>/dev/null || stat -f%Sm "$file" 2>/dev/null || echo "unknown")
            echo "  ✓ $file exists ($size bytes, modified: $mtime)"
          else
            echo "  ✗ $file MISSING!"
            exit 1
          fi
        done
        echo ""
        echo "Checking stories directory:"
        if [ -d "stories" ]; then
          story_count=$(find stories -name "*.html" -type f | wc -l)
          total_size=$(du -sb stories 2>/dev/null | cut -f1 || echo "unknown")
          echo "  ✓ stories/ directory exists"
          echo "  ✓ Found $story_count HTML files (total size: $total_size bytes)"
          if [ "$story_count" -eq 0 ]; then
            echo "  ⚠️  WARNING: No story HTML files found!"
          fi
        else
          echo "  ✗ stories/ directory MISSING!"
          exit 1
        fi
        echo ""
        echo "File sizes summary:"
        du -h feed.xml index.html 2>/dev/null || true
        echo ""
        echo "Stories directory contents (first 10):"
        ls -lh stories/ 2>/dev/null | head -10 || echo "  (empty or error)"
        
    - name: Deploy to gh-pages branch
      working-directory: gh-pages
      run: |
        echo "=== Deploying to gh-pages branch ==="
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Show what we're about to commit
        echo "Files to deploy:"
        ls -lh | grep -v "^d" | head -10
        echo ""
        echo "Story files:"
        ls -lh stories/ 2>/dev/null | head -10 || echo "No stories"
        
        # Make sure .nojekyll exists
        touch .nojekyll
        
        # Add all generated files
        git add feed.xml index.html stories/ .nojekyll
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          echo "Committing changes..."
          git commit -m "Update feed and stories - $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          echo "Pushing to gh-pages branch..."
          git push origin gh-pages
          
          echo "✓ Successfully deployed to gh-pages"
        fi
        
        # Log deployment info
        REPO_NAME="${{ github.event.repository.name }}"
        OWNER="${{ github.repository_owner }}"
        PAGE_URL="https://${OWNER}.github.io/${REPO_NAME}"
        echo ""
        echo "=== Deployment Status ==="
        echo "Page URL: ${PAGE_URL}"
        echo "Deployment completed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
