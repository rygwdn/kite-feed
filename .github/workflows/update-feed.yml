name: Update Kite Feed and Deploy

on:
  schedule:
    # Run every 6 hours including 13:00 UTC (at 01:00, 07:00, 13:00, 19:00)
    - cron: '0 1,7,13,19 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches:
      - main

permissions:
  contents: write  # Need write permission to push to gh-pages

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      
    - name: Checkout gh-pages branch (for existing stories)
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages-existing
      continue-on-error: true  # OK if gh-pages doesn't exist yet
      
    - name: Setup output directory with existing stories
      run: |
        mkdir -p gh-pages-output/stories
        
        # Copy existing stories if gh-pages branch exists
        if [ -d "gh-pages-existing/stories" ]; then
          echo "Copying existing stories from gh-pages branch"
          cp -r gh-pages-existing/stories/* gh-pages-output/stories/ 2>/dev/null || true
          existing_count=$(ls -1 gh-pages-output/stories/*.html 2>/dev/null | wc -l || echo "0")
          echo "Found $existing_count existing stories"
        else
          echo "No existing gh-pages branch found, starting fresh"
        fi
      
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        uv sync
        
    - name: Run processing workflow
      run: |
        echo "=== Running build with output to gh-pages-output directory ==="
        
        # Count existing stories
        existing_count=$(ls -1 gh-pages-output/stories/*.html 2>/dev/null | wc -l || echo "0")
        echo "Existing stories: $existing_count"
        
        # Run the processing workflow with output directory set to gh-pages-output
        uv run process --output-dir gh-pages-output
        
        # Count new stories
        new_count=$(ls -1 gh-pages-output/stories/*.html 2>/dev/null | wc -l || echo "0")
        echo "Total stories now: $new_count (added $((new_count - existing_count)) new)"
        
    - name: Verify generated files
      run: |
        echo "=== Verifying Generated Files ==="
        echo ""
        echo "Checking key files:"
        for file in feed.xml index.html; do
          if [ -f "gh-pages-output/$file" ]; then
            size=$(wc -c < "gh-pages-output/$file" 2>/dev/null || echo "unknown")
            echo "  ✓ $file exists ($size bytes)"
          else
            echo "  ✗ $file MISSING!"
            exit 1
          fi
        done
        echo ""
        echo "Checking stories directory:"
        if [ -d "gh-pages-output/stories" ]; then
          story_count=$(find gh-pages-output/stories -name "*.html" -type f | wc -l)
          total_size=$(du -sb gh-pages-output/stories 2>/dev/null | cut -f1 || echo "unknown")
          echo "  ✓ stories/ directory exists"
          echo "  ✓ Found $story_count HTML files (total size: $total_size bytes)"
          if [ "$story_count" -eq 0 ]; then
            echo "  ⚠️  WARNING: No story HTML files found!"
          fi
        else
          echo "  ✗ stories/ directory MISSING!"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages-output
        publish_branch: gh-pages
        enable_jekyll: false
        commit_message: 'Update feed and stories - ${{ github.sha }}'
